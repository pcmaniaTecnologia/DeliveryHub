
'use client';

import React, { createContext, useContext, useState, useEffect, useRef, ReactNode, useCallback } from 'react';
import { useFirestore, useUser } from '@/firebase';
import { collection, query, where, onSnapshot } from 'firebase/firestore';
import type { Order } from '@/app/dashboard/orders/page';
import { generateOrderPrintHtml } from '@/lib/print-utils';
import { useToast } from '@/hooks/use-toast';

const notificationSound = "data:audio/ogg;base64,T2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rDkF2dioBsZ4AvoH4ECkVc29wAAAAADG6k8sBAPr///////8AAAAAAAAAAP///////////////wAAABQAAAAAAAAAAAAAAABfT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rAQB3AAAAai5Rs//h4AAAciIBAML/////////////////AAAAAD////////8BAAAUAAAAAAAAAAAAAAAAY09nZ1MAAAAAAAAAAAAAAADTgGAAAAAAAABqTS/rAgA+QQAAfR4eAkQB/////////////////////wEAAAAUAAAAAAAAAAAAAAAAWk9nZ1MAAAAAAAAAAAAAAADTgGAAAAAAAABqTS/rBQD9AQAAZgEBAAABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rAwB/yAAARgEBAQABAAAAGAAAAAAAAAAAAAAAAP///////////////wAAABQAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAAYgEBAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAAZAEDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB3AQAAbAEBAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQBGAQAAgQEBAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAAnQEBAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB/AQAAqgEBAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQD9AQAArwEBAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAAwQEDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB3AQAAdAEBAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQBGAQAA8AEBAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAA+AEDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB/AQAABAIDAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQD9AQAADQIDAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAAEgIDAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB3AQAAHAIDAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQBGAQAAIgIDAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAAKgIDAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB/AQAAOgIDAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQD9AQAAQQIDAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAAUgIDAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB3AQAAWgIDAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQBGAQAAZgIDAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAAcgIDAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB/AQAAgQIDAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQD9AQAAiwIDAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAAkwIDAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB3AQAAoQIDAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQBGAQAAqgIDAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAAswIDAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB/AQAAuwIDAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQD9AQAAvwIDAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAAxQIDAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB3AQAAzQIDAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQBGAQAA1QIDAQABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQBGAQAA2gIDAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAA5QIDAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB/AQAA6wIDAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQD9AQAA8QIDAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAABAMDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB3AQAAEAMDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAAIAMDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQBGAQAAKgMDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB/AQAANgMDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQD9AQAAQQMDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAAUgMDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB3AQAAXgMDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQBGAQAAZgMDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAAcgMDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB/AQAAgwMDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQD9AQAAjAMDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAAkwMDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB3AQAAoAMDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAAqwMDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAAswMDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB/AQAAuwMDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQD9AQAAwAMDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAAxQMDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB3AQAAzAMDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQBGAQAA0wMDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAA2QMDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB/AQAA4gMDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQD9AQAA5gMDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQBGAQAA7AMDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAA8AMDAwABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB/AQAABgQEAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQD9AQAAEQQEAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAAFgQEAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB3AQAAIAQEAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAAKgQEAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAAOAQEAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB/AQAAQggeAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQD9AQAAUAQEAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAAWgQEAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB3AQAAZAQEAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQBGAQAAagQEAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAAgAQEAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB/AQAAiQQEAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQD9AQAAkQQEAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAAngQEAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB3AQAApwQEAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAAqwQEAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQBGAQAAswQEAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB/AQAAuwQEAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQD9AQAAwQQEAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAAxQQEAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQB3AQAAygQEAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQAFAQAA0QQEAgABAAAAAAAAAAAAAAAAAAAAAABPT2dnUwACAAAAAAAAAADTgGAAAAAAAABqTS/rBQBGAQAA2gQE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ABoAAAAAAAAAAGpNL+sFACQAAPB1BwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAANwAAAAAAAAAAGpNL+sFABYBAMACBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAANQAAAAAAAAAAGpNL+sFACYCAMAFBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAALwAAAAAAAAAAGpNL+sFADICAMALBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAAKgAAAAAAAAAAGpNL+sFACgCAMASBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAAJQAAAAAAAAAAGpNL+sFABACAMAZBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAAIgAAAAAAAAAAGpNL+sFAD4AAMAhBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAAFwAAAAAAAAAAGpNL+sFADgAAMApBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAADgAAAAAAAAAAGpNL+sFADAAAMAzBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAABgAAAAAAAAAAGpNL+sFACQAAMDABwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAAOYAAAAAAAAAAGpNL+sFABYAAMBIBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAANoAAAAAAAAAAGpNL+sFACYBAMBRBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAAMgAAAAAAAAAAGpNL+sFADIBAMBcBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAAKoAAAAAAAAAAGpNL+sFACgBAMBlBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAAJoAAAAAAAAAAGpNL+sFABABAMBvBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAAIoAAAAAAAAAAGpNL+sFAD4BAMB+BwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAAF4AAAAAAAAAAGpNL+sFADgBAMCJBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAADoAAAAAAAAAAGpNL+sFADABAMCdBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAABoAAAAAAAAAAGpNL+sFACQBAMCsBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAANwAAAAAAAAAAGpNL+sFABYBAMCwBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAANQAAAAAAAAAAGpNL+sFACYBAMC1BwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAALwAAAAAAAAAAGpNL+sFADIBAMC9BwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAAKgAAAAAAAAAAGpNL+sFACgBAMDEBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAAJQAAAAAAAAAAGpNL+sFABABAMDSBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAAIgAAAAAAAAAAGpNL+sFAD4BAMDZBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAAFwAAAAAAAAAAGpNL+sFADgBAMDjBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAADgAAAAAAAAAAGpNL+sFADABAMDtBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAABgAAAAAAAAAAGpNL+sFACQBAMDyBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAAOYAAAAAAAAAAGpNL+sFABYBAPAEBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAANoAAAAAAAAAAGpNL+sFACYBAPAKBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAAMgAAAAAAAAAAGpNL+sFADIBAPATBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAAKoAAAAAAAAAAGpNL+sFACgBAPAbBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAAJoAAAAAAAAAAGpNL+sFABABAPAjBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAAIoAAAAAAAAAAGpNL+sFAD4BAPApBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAAF4AAAAAAAAAAGpNL+sFADgBAPAyBwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAADoAAAAAAAAAAGpNL+sFADABAPA5BwUEAQEAAAAAAAAAAAAAAAAAAAAAAU9PZ2dTAAIAAAAAAAAAABoAAAAAAAAAAGpNL+sFACQBAPBB";

interface NotificationContextType {
    isEnabled: boolean;
    isActivating: boolean;
    activateSystem: () => void;
}

const NotificationContext = createContext<NotificationContextType | undefined>(undefined);

export const NotificationProvider = ({ children, companyData }: { children: ReactNode, companyData?: { soundNotificationEnabled?: boolean; autoPrintEnabled?: boolean; name?: string }}) => {
    const { toast } = useToast();
    const { user } = useUser();
    const firestore = useFirestore();

    const [isEnabled, setIsEnabled] = useState(false);
    const [isActivating, setIsActivating] = useState(false);
    const audioRef = useRef<HTMLAudioElement | null>(null);
    const processedOrderIds = useRef(new Set<string>());
    const listenerUnsubscribe = useRef<() => void | null>(null);
    
    // Initialize Audio Ref
    useEffect(() => {
        if (!audioRef.current) {
            audioRef.current = new Audio(notificationSound);
            audioRef.current.preload = 'auto';
        }
    }, []);

    const playSound = useCallback(() => {
        if (audioRef.current && companyData?.soundNotificationEnabled) {
            audioRef.current.currentTime = 0;
            audioRef.current.play().catch(err => {
                console.error("Audio playback failed. User may need to interact with the page again.", err);
                toast({
                    variant: 'destructive',
                    title: 'Erro na Notificação Sonora',
                    description: 'Clique na página novamente para reativar o som.',
                });
                setIsEnabled(false);
            });
        }
    }, [companyData?.soundNotificationEnabled, toast]);

    const printOrder = useCallback((order: Order) => {
        if (companyData?.autoPrintEnabled) {
            const printHtml = generateOrderPrintHtml(order, companyData);
            const printWindow = window.open('', '_blank', 'width=300,height=500');
            if (printWindow) {
                printWindow.document.write(printHtml);
                printWindow.document.close();
            } else {
                 toast({
                    variant: 'destructive',
                    title: 'Impressão Bloqueada',
                    description: 'Por favor, habilite pop-ups para impressão automática.',
                });
            }
        }
    }, [companyData, toast]);

    const listenToNewOrders = useCallback(() => {
        if (!firestore || !user?.uid) return;

        const q = query(
            collection(firestore, `companies/${user.uid}/orders`),
            where('status', 'in', ['Novo', 'Aguardando pagamento'])
        );

        listenerUnsubscribe.current = onSnapshot(q, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === 'added') {
                    const order = { id: change.doc.id, ...change.doc.data() } as Order;
                    if (!processedOrderIds.current.has(order.id)) {
                        processedOrderIds.current.add(order.id);
                        playSound();
                        printOrder(order);
                    }
                }
            });
        });
        
    }, [firestore, user?.uid, playSound, printOrder]);

    const activateSystem = useCallback(() => {
        if (isEnabled) return;
        setIsActivating(true);

        if (!audioRef.current) {
            toast({ variant: 'destructive', title: 'Erro de Áudio' });
            setIsActivating(false);
            return;
        }

        // The user interaction allows us to "unlock" the audio.
        audioRef.current.play().then(() => {
            audioRef.current?.pause();
            audioRef.current!.currentTime = 0;
            
            toast({
                title: 'Sistema Ativado',
                description: 'Aguardando novos pedidos...',
            });
            
            setIsEnabled(true);
            listenToNewOrders();

        }).catch(err => {
            console.error("Could not activate audio:", err);
            toast({
                variant: 'destructive',
                title: 'Não foi possível ativar o som',
                description: 'Seu navegador pode estar bloqueando a reprodução automática.',
            });
        }).finally(() => {
            setIsActivating(false);
        });

    }, [isEnabled, listenToNewOrders, toast]);

    // Cleanup listener on unmount
    useEffect(() => {
        const unsubscribe = listenerUnsubscribe.current;
        return () => {
            if (unsubscribe) {
                unsubscribe();
            }
        };
    }, []);

    const value = {
        isEnabled,
        isActivating,
        activateSystem,
    };

    return <NotificationContext.Provider value={value}>{children}</NotificationContext.Provider>;
};

export const useNotifications = (): NotificationContextType => {
    const context = useContext(NotificationContext);
    if (context === undefined) {
        throw new Error('useNotifications must be used within a NotificationProvider');
    }
    return context;
};
